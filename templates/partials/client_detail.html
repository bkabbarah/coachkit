<div 
    hx-get="/client/{{ client.id }}/analytics"
    hx-target="#analytics-content"
    hx-trigger="load, checkinAdded from:body"
    hx-swap="innerHTML"
></div>

<div class="bg-white p-6 rounded shadow">
    <div class="flex justify-between items-start mb-4">
        <div>
            <h3 class="font-bold text-xl">{{ client.name }}</h3>
            <p class="text-gray-500">{{ client.email }}</p>
        </div>
        <div class="flex gap-2 items-center">
            {% if client.is_at_risk() %}
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-sm">At Risk</span>
            {% else %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">On Track</span>
            {% endif %}
            <button
                hx-get="/client/{{ client.id }}/delete-modal"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                class="text-red-600 hover:text-red-800 text-sm"
            >
                Delete
            </button>
        </div>
    </div>
    
    <!-- At Risk Section -->
    <div 
        id="at-risk-section"
        hx-get="/client/{{ client.id }}/at-risk-status"
        hx-trigger="checkinAdded from:body"
        hx-swap="innerHTML"
    >
        {% if client.is_at_risk() %}
        <div class="bg-red-50 border border-red-200 rounded p-4 mb-4">
            <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold text-red-700">⚠️ Client At Risk</h4>
                <button
                    hx-post="/client/{{ client.id }}/generate-message"
                    hx-target="#message-container"
                    hx-swap="innerHTML"
                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                >
                    Generate Re-engagement Message
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-3">This client hasn't checked in for {{ client.days_since_checkin() }} days.</p>
            <div id="message-container"></div>
        </div>
        {% endif %}
    </div>
    
    <!-- Goal Section -->
    <div class="border-t pt-4 mt-4">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Goal</h4>
            <button
                hx-get="/client/{{ client.id }}/edit-goal"
                hx-target="#goal-section"
                hx-swap="innerHTML"
                class="text-blue-600 hover:text-blue-800 text-sm"
            >
                Edit
            </button>
        </div>
        <div id="goal-section"
            hx-get="/client/{{ client.id }}/goal"
            hx-trigger="checkinAdded from:body"
        >
            {% if client.goal_weight %}
                <div class="flex gap-8 mb-2">
                    <div>
                        <p class="text-sm text-gray-500">Target</p>
                        <p class="font-medium">{{ client.goal_weight }} lbs</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Current</p>
                        <p class="font-medium">{{ client.current_weight() or '—' }} lbs</p>
                    </div>
                    {% if client.goal_progress() is not none %}
                    {% set progress = client.goal_progress() %}
                    <div>
                        <p class="text-sm text-gray-500">Progress</p>
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                {% if progress < 0 %}
                                    <div class="h-2 bg-red-500 rounded-full" style="width: {{ [progress|abs, 100]|min }}%"></div>
                                {% elif progress > 100 %}
                                    <div class="h-2 bg-yellow-500 rounded-full" style="width: 100%"></div>
                                {% else %}
                                    <div class="h-2 bg-green-500 rounded-full" style="width: {{ progress }}%"></div>
                                {% endif %}
                            </div>
                            {% if progress < 0 %}
                                <span class="text-sm text-red-600">{{ progress|int }}%</span>
                            {% elif progress > 100 %}
                                <span class="text-sm text-yellow-600">{{ progress|int }}%</span>
                            {% else %}
                                <span class="text-sm">{{ progress|int }}%</span>
                            {% endif %}
                        </div>
                        {% if progress < 0 %}
                            <p class="text-xs text-red-600 mt-1">Moving away from goal</p>
                        {% elif progress > 100 %}
                            <p class="text-xs text-yellow-600 mt-1">Passed goal — check in with client</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            {% else %}
                <p class="text-gray-500 text-sm">No goal set</p>
            {% endif %}
            
            {% if client.notes %}
                <p class="text-gray-700 mt-2">{{ client.notes }}</p>
            {% endif %}
        </div>
    </div>
        
    <!-- Check-In Section -->
    <div class="border-t pt-4 mt-4">
        <h4 class="font-semibold mb-2">Add Check-In</h4>
        <form 
            hx-post="/client/{{ client.id }}/checkin"
            hx-target="#checkins-list"
            hx-swap="afterbegin"
            hx-on::after-request="this.reset()"
            hx-encoding="multipart/form-data"
            class="space-y-3 mb-4"
        >
            <div class="flex gap-2">
                <input 
                    type="text" 
                    name="note" 
                    placeholder="Notes (e.g., 'Great session, hit PR')"
                    class="border rounded px-3 py-2 flex-1"
                >
                <input 
                    type="number"
                    step="0.1"
                    name="weight" 
                    placeholder="Weight (lbs)"
                    class="border rounded px-3 py-2 w-32"
                >
            </div>
            <div class="flex gap-2 items-center">
                <input 
                    type="file" 
                    name="photo" 
                    accept="image/*"
                    class="text-sm"
                >
                <button 
                    type="submit"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                >
                    Add Check-In
                </button>
            </div>
        </form>
        
        <h4 class="font-semibold mb-2">Check-In History</h4>
        <div id="checkins-list">
            {% if client.checkins %}
                {% for checkin in client.checkins %}
                <div class="border-l-4 border-blue-400 pl-3 py-2 mb-2">
                    <p class="text-sm text-gray-500">{{ checkin.created_at.strftime('%b %d, %Y at %I:%M %p') }}</p>
                    <p>{{ checkin.note or 'No notes' }}</p>
                    {% if checkin.weight %}
                        <p class="text-sm text-gray-600">Weight: {{ checkin.weight }} lbs</p>
                    {% endif %}
                    {% if checkin.photo %}
                        <img 
                            src="/static/uploads/{{ checkin.photo }}" 
                            alt="Progress photo"
                            class="mt-2 rounded max-w-xs cursor-pointer hover:opacity-90"
                            hx-get="/checkin/{{ checkin.id }}/photo-view"
                            hx-target="#modal-container"
                            hx-swap="innerHTML"
                        >
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500 text-sm">No check-ins yet.</p>
            {% endif %}
        </div>
    </div>
</div>